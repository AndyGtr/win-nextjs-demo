---
  name: Build and deploy Node.js app to Azure Web App - win-nextjs-demo-220724
  on:
    push:
      branches:
        - main
    workflow_dispatch: null
  jobs:
    build:
      runs-on: windows-latest
      steps:
        - uses: actions/checkout@v4
        - name: Set up Node.js version
          uses: actions/setup-node@v3
          with:
            node-version: 18.x
        - name: yarn install and build
          run: |
            yarn install
            yarn build
        - name: Copy static files
          run: |
            cp -R ./public ./.next/standalone/public
            cp -R ./.next/static ./.next/standalone/.next/static
        - name: Upload artifact for deployment job
          uses: actions/upload-artifact@v4
          with:
            name: app
            path: .next/standalone
    deploy:
      runs-on: ubuntu-latest
      needs: build
      environment:
        name: production
        url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
      steps:
        - name: Download artifact from build job
          uses: actions/download-artifact@v4
          with:
            name: app
        - name: Deploy to Azure Web App
          id: deploy-to-webapp
          uses: azure/webapps-deploy@v3
          with:
            app-name: win-nextjs-demo-220724
            publish-profile: ${{secrets.AZUREAPPSERVICE_PUBLISHPROFILE_6F11C83AC4C243F4B8E0ED2120CDDC96}}
            package: .
  